var buildGroupsAndColumnsForCountry=function(e,t){var a=[[]],o=[];if("cyclone"==e.hazard)$.each(t.data.summary.prob_class,function(e,t){var r=t.by_month;o.push([e].concat(r)),a[0].push(e)});else if("drought"==e.hazard){for(var r=0;r<e.groups.length;r++){var i=e.group_prefix,s=e.group_key,n=e.group_modifier,l=e.groups[r],p=t.data.summary[s][""+l*n].by_month;o.push([i+l].concat(p)),a[0].push(i+l)}o.reverse()}else if("flood"==e.hazard){for(var r=0;r<e.groups.length;r++){var i=e.group_prefix,s=e.group_key,l=e.groups[r],n=e.group_modifier,p=t.data.summary[s][""+l*n].by_month;o.push([i+l].concat(p)),a[0].push(i+l)}o.reverse()}return{groups:a,columns:o}},buildGroupsAndColumnsForAdmin2=function(e,t,a){var o=[[]],r=[];if("flood"==e.hazard){for(var i=0;i<e.returnPeriods.length;i++){var s=e.returnPeriods[i],n=t.data.summary.admin2[a].rp[""+s].by_month;r.push(["rp"+s].concat(n)),o[0].push("rp"+s)}r.reverse()}else"cyclone"==e.hazard&&$.each(t.data.summary.admin2[a].prob_class,function(e,t){var a=t.by_month;r.push([e].concat(a)),o[0].push(e)});return{groups:o,columns:r}},buildHazardChart=function(e,t,a){var o=void 0;if("bar"==e.type){o=void 0!=a&&void 0!=a.groups&&void 0!=a.columns?{groups:a.groups,columns:a.columns}:buildGroupsAndColumnsForCountry(e,t);var r=void 0;"bullet"==e.subtype?(r={bullet:!0,width:function(e,t){return"rp25"==e.id?8:16},offset:function(e,t){return 0}},void 0!=a&&void 0!=a.bullet_width&&(r.width=a.bullet_width)):r={width:{ratio:.6}};var i={x:{},y:{}};void 0!=e.axis&&void 0!=e.axis.x&&"months"==e.axis.x.type&&(i.x.tick={format:function(e){return months_short_3[e].toTitleCase()}}),i.y.label=e.axis.y.label,i.y.tick={format:d3.format("s,")};c3.generate({bindto:"#"+e.id,data:{columns:o.columns,groups:o.groups,type:"bar",colors:e.colors},axis:i,bar:r})}},init_start=function(e){var t=geosite.map_config.featurelayers.popatrisk.urls.summary.replace("{iso3}",geosite.initial_state.iso3).replace("{hazard}",geosite.initial_state.hazard),a=geosite.map_config.featurelayers.popatrisk.urls.geojson.replace("{iso3}",geosite.initial_state.iso3).replace("{hazard}",geosite.initial_state.hazard);$.when($.ajax({dataType:"json",url:t}),$.ajax({dataType:"json",url:a})).done(function(t,a){geosite.initial_data.layers.popatrisk.data.summary=t[0],geosite.initial_data.layers.popatrisk.data.geojson=a[0],init_main_app(e)})},init_main_app=function(e){geosite.app=app=angular.module(e,["ngRoute"]),app.factory("state",function(){return $.extend({},geosite.initial_state)}),app.factory("stateschema",function(){return $.extend({},geosite.state_schema)}),app.factory("popatrisk_config",function(){return $.extend({},geosite.initial_data.layers.popatrisk)}),app.factory("map_config",function(){return $.extend({},geosite.map_config)}),app.factory("live",function(){return{map:void 0,baselayers:{},featurelayers:{popatrisk:void 0}}}),geosite.init_controller_base(app),init_sparc_controller_main($(".geosite-controller.geosite-main"),app),angular.bootstrap(document,[e])},init_sparc_controller=function(e,t){var a=e.data("controllerName");e.data("controllerType");t.controller(a,function(e,t){init_intents($(t),e)})};geosite.controller_main=function(e,t,a,o,r,i,s,n,l,p){e.state=geosite.init_state(i,n),e.live=p,e.$on("stateChanged",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope();a.$apply(function(){a.state=$.extend(a.state,t);var e=buildPageURL("countryhazardmonth_detail",a.state);history.replaceState(i,"",e),a.$broadcast("refreshMap",{state:a.state})})}),e.$on("filterChanged",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope();a.$apply(function(){a.state.filters[t.layer]=$.extend(a.state.filters[t.layer],t.filter);var e=buildPageURL("countryhazardmonth_detail",a.state);history.replaceState(i,"",e),a.$broadcast("refreshMap",{state:a.state})})}),e.$on("viewChanged",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope();a.state.view=$.extend(a.state.view,t);var o=buildPageURL("countryhazardmonth_detail",a.state);history.replaceState(i,"",o)}),e.$on("layerLoaded",function(e,t){var a=angular.element("#geosite-main").scope(),o=t.type,r=t.layer;"featurelayer"==o?a.state.view.featurelayers.push(r):"baselayer"==o&&(a.state.view.baselayer=r)}),e.$on("showLayer",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope(),o=t.layer;-1==$.inArray(o,a.state.view.featurelayers)&&(a.state.view.featurelayers.push(o),a.$broadcast("refreshMap",{state:a.state}))}),e.$on("hideLayer",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope(),o=t.layer,r=$.inArray(o,a.state.view.featurelayers);-1!=r&&(a.state.view.featurelayers.splice(r,1),a.$broadcast("refreshMap",{state:a.state}))}),e.$on("switchBaseLayer",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope();a.state.view.baselayer=t.layer,a.$broadcast("refreshMap",{state:a.state})}),e.$on("zoomToLayer",function(e,t){var a=angular.element("#geosite-main").scope(),o=t.layer,r=$.inArray(o,a.state.view.featurelayers);-1!=r&&a.$broadcast("changeView",{layer:o})}),e.$on("clickedOnMap",function(e,t){console.log("event",e),console.log("args",t);var a=angular.element("#geosite-main").scope(),i=a.state.view.z,n=a.state.view.featurelayers;console.log("visibleFeatureLayers",n);for(var l={},p={},u=[],c=0;c<n.length;c++){var d=s.featurelayers[n[c]];if(void 0!=d.wfs)for(var g={service:"wfs",version:d.wfs.version,request:"GetFeature",srsName:"EPSG:4326"},f=new L.LatLng(t.lat,t.lon),m=geosite.tilemath.point_to_bbox(t.lon,t.lat,i,4).join(","),h=d.wfs.layers||d.wms.layers||[],y=0;y<h.length;y++){typeName=h[y];var v=d.wfs.url+"?"+$.param($.extend(g,{typeNames:typeName,bbox:m}));u.push(v),p[typeName.toLowerCase()]=geosite.layers.aggregate_fields(d),l[typeName.toLowerCase()]=d}}r.all(geosite.http.build_promises(o,u)).then(function(e){var t=geosite.http.build_features(e,p);if(console.log("Features: ",t),t.length>0){var o=geosite.utility.getClosestFeature(t,f),r=l[o.featuretype];a.$broadcast("openPopup",{featureLayer:r,feature:o,location:{lon:o.geometry.lng,lat:o.geometry.lat}})}})})};var init_sparc_controller_main=function(e,t){geosite.init_controller(e,t,geosite.controller_main),$(".geosite-controller.geosite-sidebar",e).each(function(){geosite.init_controller($(this),t,geosite.controller_sidebar)}),$(".geosite-controller.geosite-map",e).each(function(){geosite.init_controller($(this),t,geosite.controller_map),geosite.init_controllers($(this),t,[{selector:".geosite-controller.geosite-map-map",controller:geosite.controller_map_map},{selector:".geosite-controller.sparc-map-calendar",controller:void 0},{selector:".geosite-controller.sparc-map-breadcrumb",controller:geosite.controller_breadcrumb},{selector:".geosite-controller.geosite-map-filter",controller:geosite.controller_filter},{selector:".geosite-controller.geosite-map-legend",controller:void 0}])})};geosite.controller_map=function(e,t,a,o,r,i){},geosite.controller_breadcrumb=function(e,t,a,o){angular.extend(this,a("GeositeControllerBase",{$element:t,$scope:e})),$("select",t).each(function(){var t=$(this),a=t.data("breadcrumbs"),r=t.data("placeholder"),i=t.data("initialData"),s=t.data("width"),n=t.data("height"),l="sparc-select-dropdown";t.select2({data:geosite.initial_data.data[i],placeholder:r,allowClear:!1,width:s,height:n,dropdownCssClass:l}),t.on("select2:select",function(r){var i=r.params.data.id;e.$apply(function(){var a=t.data("output");e.state[a]=i});for(var s="",n=0;n<a.length;n++){var l=a[n];void 0!=o[l.value]&&(s+="/"+l.name+"/"+e.state[l.value])}console.log("Going to url ",s),window.location.href=s})})},geosite.controller_filter=function(e,t,a,o,r,i,s){var n=r.data.summary.all.max.at_admin2_month;angular.extend(this,a("GeositeControllerBase",{$element:t,$scope:e})),$(t).on("change",'input:radio[name="cat"]',function(t){console.log(t);var a=$(this).data("output"),o={};o[a]=this.value,geosite.intend("filterChanged",{layer:"popatrisk",filter:o},e)}),$(".geosite-filter-slider",$(t)).each(function(){var t=$(this).find(".geosite-filter-slider-slider"),a=$(this).find(".geosite-filter-slider-label"),r=t.data("type"),i=t.data("output");if("ordinal"==r){var s=t.data("range"),l=o.filters.popatrisk[i],p=t.data("options");t.data("label",a),geosite.ui_init_slider_label(t,r,s,l),geosite.ui_init_slider_slider(e,t,r,s,p.indexOf(l),0,p.length-1,1)}else{var s=t.data("range"),u=geosite.assert_float(t.data("min-value"),void 0),c=t.data("step");if("true"==s.toLowerCase()){var d=void 0!=n?n:geosite.assert_float(t.data("max-value"),void 0),g=o.filters.popatrisk[i];g=geosite.assert_array_length(g,2,[u,d]);var f=[Math.floor(g[0]),Math.floor(g[1])],m=Math.floor(u),h=Math.floor(d),y=Math.floor(c);t.data("label",a),geosite.ui_init_slider_label(t,r,s,g),geosite.ui_init_slider_slider(e,t,r,s,f,m,h,y),console.log(v,m,h,y,s)}else{var d=geosite.assert_float(t.data("max-value"),void 0),l=o.filters.popatrisk[i],v=Math.floor(100*l),m=Math.floor(100*u),h=Math.floor(100*d),y=Math.floor(100*c);t.data("label",a),geosite.ui_init_slider_label(t,r,s,l),geosite.ui_init_slider_slider(e,t,r,s,f,m,h,y),console.log(v,m,h,y,s)}}})};var init_map=function(e){var t=L.map("map",{zoomControl:opt_b(e,"zoomControl",!1),minZoom:opt_i(e,"minZoom",3),maxZoom:opt_i(e,"maxZoom",18)});return t.setView([opt_i(e,["latitude","lat"],0),opt_i(e,["longitude","lon","lng","long"],0)],opt_i(e,["zoom","z"],0)),$.each(opt_j(e,"listeners"),function(e,a){t.on(e,a)}),t};geosite.controller_map_map=function(e,t,a,o,r,i,s){var n={click:function(t){var a=t.latlng,o={lat:a.lat,lon:a.lng};geosite.intend("clickedOnMap",o,e)},zoomend:function(t){var a={extent:s.map.getBounds().toBBoxString(),z:s.map.getZoom()};geosite.intend("viewChanged",a,e)},dragend:function(t){var a=s.map.getCenter(),o={extent:s.map.getBounds().toBBoxString(),lat:a.lat,lon:a.lng};geosite.intend("viewChanged",o,e)},moveend:function(t){var a=s.map.getCenter(),o={extent:s.map.getBounds().toBBoxString(),lat:a.lat,lon:a.lng};geosite.intend("viewChanged",o,e)}},l=hasHashValue(["latitude","lat","longitude","lon","lng","zoom","z"]),p=o.view;s.map=init_map({zoomControl:i.controls.zoom,minZoom:i.view.minZoom,maxZoom:i.view.maxZoom,lat:p.lat,lon:p.lon,z:p.z,listeners:n});var u=geosite.layers.init_baselayers(s.map,i.baselayers);$.extend(s.baselayers,u);var c=i.baselayers[0].id;s.baselayers[c].addTo(s.map),geosite.intend("viewChanged",{baselayer:c},e),geosite.intend("layerLoaded",{type:"baselayer",layer:c},e),$.each(i.featurelayers,function(t,a){"popatrisk"!=t&&geosite.layers.init_featurelayer(t,a,e,s,i)});var d=function(e){console.log(e);var t=e.feature,o=angular.element("#geosite-main").scope(),s=o.state,n=s.filters.popatrisk,l=popup_templates.popatrisk,p=$.extend({},t.properties),u=months_short_3[s.month-1],c=months_long[s.month-1];if(p.month=c,"flood"==s.hazard){var d=n.rp;p.popatrisk=t.properties["RP"+d.toString(10)][u]}else if("cyclone"==s.hazard){for(var g=n.prob_class_max,f=0,m=0;m<t.properties.addinfo.length;m++){var h=t.properties.addinfo[m];h.category==n.category&&0!=h.prob_class_max&&h.prob_class_max<=g&&(console.log("matched prob_class",g),f+=h[u])}p.popatrisk=f}var y=i.featurelayers.popatrisk.popup.chart;return p.chartID=y.id,setTimeout(function(){var e=buildGroupsAndColumnsForAdmin2(y,r,t.properties.admin2_code),a={groups:e.groups,columns:e.columns,bullet_width:function(e,t){return"rp25"==e.id?6:12}};buildHazardChart(y,r,a)},1e3),a(l)(p)};s.featurelayers.popatrisk=L.geoJson(r.data.geojson,{renderOrder:$.inArray("popatrisk",i.renderlayers),style:r.style["default"],hoverStyle:r.style.hover,onEachFeature:function(e,t){var a={maxWidth:300};t.bindPopup(d,a),t.on({mouseover:highlightFeature,mouseout:function(e){s.featurelayers.popatrisk.resetStyle(e.target)},click:function(e){}})}}),l||s.map.fitBounds(s.featurelayers.popatrisk.getBounds()),$("#geosite-map-sidebar-toggle").click(function(){$(this).toggleClass("sidebar-open"),$("#geosite-sidebar, #geosite-map").toggleClass("sidebar-open"),setTimeout(function(){s.map.invalidateSize({animate:!0,pan:!1})},2e3)}),e.$on("refreshMap",function(e,t){console.log("Refreshing map...");var a=t.state.view.baselayer;$.each(s.baselayers,function(e,t){var o=e==a;s.map.hasLayer(t)&&!o?s.map.removeLayer(t):!s.map.hasLayer(t)&&o&&s.map.addLayer(t)});var o=t.state.view.featurelayers;$.each(s.featurelayers,function(e,t){var a=-1!=$.inArray(e,o);s.map.hasLayer(t)&&!a?s.map.removeLayer(t):!s.map.hasLayer(t)&&a&&s.map.addLayer(t)});var i=$.grep(layersAsArray(s.featurelayers),function(e){return-1!=$.inArray(e.id,o)}),n=sortLayers($.map(i,function(e,t){return e.layer}),!0),l=($.map(s.baselayers,function(e,t){return{id:t,layer:e}}),$.map($.grep(layersAsArray(s.baselayers),function(e){return e.id==a}),function(e,t){return e.layer}));updateRenderOrder(l.concat(n)),s.featurelayers.popatrisk.setStyle(r.style["default"]),setTimeout(function(){s.map._onResize()},0)}),e.$on("changeView",function(e,t){console.log("Refreshing map..."),void 0!=t.layer&&s.map.fitBounds(s.featurelayers[t.layer].getBounds())}),e.$on("openPopup",function(e,t){console.log("Refreshing map..."),void 0!=t.featureLayer&&void 0!=t.feature&&void 0!=t.location&&geosite.popup.openPopup(a,t.featureLayer,t.feature,t.location,s.map)})},geosite.controller_sidebar=function(e,t,a,o,r,i,s){angular.extend(this,a("GeositeControllerBase",{$element:t,$scope:e}));$(t);if(void 0!=i.charts)for(var n=0;n<i.charts.length;n++){var l={};"drought"==i.charts[n].hazard&&(l.bullet_width=function(e,t){return"p6"==e.id?6:"p8"==e.id?8:16}),buildHazardChart(i.charts[n],r,l)}},geosite.style_cyclone=function(e,t,a,o){for(var r={},i=t.filters.popatrisk,s=i.prob_class_max,n=i.popatrisk_range,l=months_short_3[t.month-1],p=0,u=0;u<e.properties.addinfo.length;u++){var c=e.properties.addinfo[u];c.category==i.category&&0!=c.prob_class_max&&c.prob_class_max<=s&&(console.log("matched prob_class",s),p+=c[l])}if(p>=n[0]&&p<=n[1]){for(var d=a.featurelayers.popatrisk.symbology.colors,g=o.data.summary.all.breakpoints.natural,f=void 0,u=0;u<g.length;u++)if(p<g[u]){f=d[u];break}r.fillColor=void 0==f?d[d.length-1]:f}else r.opacity=0,r.fillOpacity=0;return r},geosite.style_drought=function(e,t,a,o){for(var r={},i=t.filters.popatrisk,s=i.prob_class_max/100,n=i.popatrisk_range,l=months_short_3[t.month-1],p=0,u=0;u<e.properties.addinfo.length;u++){var c=e.properties.addinfo[u];c.month==l&&c.prob<s&&(p+=c.popatrisk)}if(p>=n[0]&&p<=n[1]){for(var d=a.featurelayers.popatrisk.symbology.colors,g=o.data.summary.all.breakpoints.natural,f=void 0,u=0;u<g.length;u++)if(p<g[u]){f=d[u];break}r.fillColor=void 0==f?d[d.length-1]:f}else r.opacity=0,r.fillOpacity=0;return r},geosite.style_flood=function(e,t,a,o){var r={},i=t.filters.popatrisk,s=i.rp,n=i.popatrisk_range,l=months_short_3[t.month-1],p=e.properties["RP"+s.toString(10)][l];if(p>=n[0]&&p<=n[1]){for(var u=a.featurelayers.popatrisk.symbology.colors,c=o.data.summary.all.breakpoints.natural_adjusted,d=void 0,g=0;g<c.length;g++)if(p<c[g]){d=u[g];break}r.fillColor=void 0==d?u[u.length-1]:d}else r.opacity=0,r.fillOpacity=0;return r};var buildPageURL=function(e,t){var a=geosite.pages[e].replace("{iso3}",t.iso3).replace("{hazard}",t.hazard).replace("{month}",t.month);return console.log("url: ",a),console.log("page: ",geosite.pages[e]),a};geosite.utility={},geosite.utility.getClosestFeature=function(e,t){var a=void 0,o=0;if(void 0!=e&&e.length>0){a=e[0],o=t.distanceTo(e[0].geometry);for(var r=0;r<e.length;r++){var i=e[r];t.distanceTo(i.geometry)<o&&(a=i,o=t.distanceTo(i.geometry))}}return a};