var buildGroupsAndColumnsForCountry=function(e,a){var t=[[]],r=[];if("cyclone"==e.hazard)$.each(a.data.summary.prob_class,function(e,a){var o=a.by_month;r.push([e].concat(o)),t[0].push(e)});else if("drought"==e.hazard){for(var o=0;o<e.groups.length;o++){var n=e.group_prefix,s=e.group_key,i=e.group_modifier,l=e.groups[o],c=a.data.summary[s][""+l*i].by_month;r.push([n+l].concat(c)),t[0].push(n+l)}r.reverse()}else if("flood"==e.hazard){for(var o=0;o<e.groups.length;o++){var n=e.group_prefix,s=e.group_key,l=e.groups[o],i=e.group_modifier,c=a.data.summary[s][""+l*i].by_month;r.push([n+l].concat(c)),t[0].push(n+l)}r.reverse()}return{groups:t,columns:r}},buildGroupsAndColumnsForAdmin2=function(e,a,t){var r=[[]],o=[];if("flood"==e.hazard){for(var n=0;n<e.returnPeriods.length;n++){var s=e.returnPeriods[n],i=a.data.summary.admin2[t].rp[""+s].by_month;o.push(["rp"+s].concat(i)),r[0].push("rp"+s)}o.reverse()}else"cyclone"==e.hazard&&$.each(a.data.summary.admin2[t].prob_class,function(e,a){var t=a.by_month;o.push([e].concat(t)),r[0].push(e)});return{groups:r,columns:o}},buildHazardChart=function(e,a,t){var r=void 0;if("bar"==e.type){r=void 0!=t&&void 0!=t.groups&&void 0!=t.columns?{groups:t.groups,columns:t.columns}:buildGroupsAndColumnsForCountry(e,a);var o=void 0;"bullet"==e.subtype?(o={bullet:!0,width:function(e,a){return"rp25"==e.id?8:16},offset:function(e,a){return 0}},void 0!=t&&void 0!=t.bullet_width&&(o.width=t.bullet_width)):o={width:{ratio:.6}};var n={x:{},y:{}};void 0!=e.axis&&void 0!=e.axis.x&&"months"==e.axis.x.type&&(n.x.tick={format:function(e){return months_short_3[e].toTitleCase()}}),n.y.label=e.axis.y.label,n.y.tick={format:d3.format("s,")};c3.generate({bindto:"#"+e.id,data:{columns:r.columns,groups:r.groups,type:"bar",colors:e.colors},axis:n,bar:o})}},init_start=function(e){init_summary(e)},init_summary=function(e){var a=map_config.featurelayers.popatrisk.urls.summary.replace("{iso3}",sparc.state.iso3).replace("{hazard}",sparc.state.hazard);$.ajax({dataType:"json",url:a,success:function(a){sparc.layers.popatrisk.data.summary=a,init_geojson(e)}})},init_geojson=function(e){var a=map_config.featurelayers.popatrisk.urls.geojson.replace("{iso3}",sparc.state.iso3).replace("{hazard}",sparc.state.hazard);$.ajax({dataType:"json",url:a,success:function(a){sparc.layers.popatrisk.data.geojson=a,init_main_app(e)}})},init_main_app=function(e){sparcApp=app=angular.module(e,["ngRoute"]),app.factory("state",function(){return $.extend({},sparc.state)}),app.factory("stateschema",function(){return $.extend({},sparc.stateschema)}),app.factory("popatrisk_config",function(){return $.extend({},sparc.layers.popatrisk)}),app.factory("map_config",function(){return $.extend({},map_config)}),app.factory("live",function(){return{map:void 0,baselayers:{},featurelayers:{popatrisk:void 0}}}),geosite.init_controller_base(app),init_sparc_controller_main($(".geosite-controller.geosite-main"),app),angular.bootstrap(document,[e])},init_sparc_controller=function(e,a){var t=e.data("controllerName");e.data("controllerType");a.controller(t,function(e,a){init_intents($(a),e)})};geosite.controller_main=function(e,a,t,r,o,n,s){e.state=geosite.init_state(r,o),e.live=s,e.$on("stateChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.$apply(function(){t.state=$.extend(t.state,a);var e=buildPageURL("countryhazardmonth_detail",r);history.replaceState(r,"",e),t.$broadcast("refreshMap",{state:t.state})})}),e.$on("filterChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.$apply(function(){t.state.filters[a.layer]=$.extend(t.state.filters[a.layer],a.filter);var e=buildPageURL("countryhazardmonth_detail",r);history.replaceState(r,"",e),t.$broadcast("refreshMap",{state:t.state})})}),e.$on("viewChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.state.view=$.extend(t.state.view,a);var o=buildPageURL("countryhazardmonth_detail",r);history.replaceState(r,"",o)}),e.$on("layerLoaded",function(e,a){var t=angular.element("#geosite-main").scope(),r=a.layer;t.state.view.featurelayers.push(r)}),e.$on("showLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope(),r=a.layer;-1==$.inArray(r,t.state.view.featurelayers)&&(t.state.view.featurelayers.push(r),t.$broadcast("refreshMap",{state:t.state}))}),e.$on("hideLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope(),r=a.layer,o=$.inArray(r,t.state.view.featurelayers);-1!=o&&(t.state.view.featurelayers.splice(o,1),t.$broadcast("refreshMap",{state:t.state}))}),e.$on("switchBaseLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.state.view.baselayer=a.layer,t.$broadcast("refreshMap",{state:t.state})}),e.$on("zoomToLayer",function(e,a){var t=angular.element("#geosite-main").scope(),r=a.layer,o=$.inArray(r,t.state.view.featurelayers);-1!=o&&t.$broadcast("changeView",{layer:r})})};var init_sparc_controller_main=function(e,a){geosite.init_controller(e,a,geosite.controller_main),$(".geosite-controller.geosite-sidebar",e).each(function(){geosite.init_controller($(this),a,geosite.controller_sidebar)}),$(".geosite-controller.geosite-map",e).each(function(){geosite.init_controller($(this),a,geosite.controller_map),geosite.init_controllers($(this),a,[{selector:".geosite-controller.geosite-map-map",controller:geosite.controller_map_map},{selector:".geosite-controller.sparc-map-calendar",controller:void 0},{selector:".geosite-controller.sparc-map-breadcrumb",controller:geosite.controller_breadcrumb},{selector:".geosite-controller.geosite-map-filter",controller:geosite.controller_filter},{selector:".geosite-controller.geosite-map-legend",controller:void 0}])})};geosite.controller_map=function(e,a,t,r,o,n){},geosite.controller_breadcrumb=function(e,a,t,r){angular.extend(this,t("GeositeControllerBase",{$element:a,$scope:e})),$("select",a).each(function(){var a=$(this),t=a.data("breadcrumbs"),o=a.data("placeholder"),n=a.data("initialData"),s=a.data("width"),i=a.data("height"),l="sparc-select-dropdown";a.select2({data:sparc.data[n],placeholder:o,allowClear:!1,width:s,height:i,dropdownCssClass:l}),a.on("select2:select",function(o){var n=o.params.data.id;e.$apply(function(){var t=a.data("output");e.state[t]=n});for(var s="",i=0;i<t.length;i++){var l=t[i];void 0!=r[l.value]&&(s+="/"+l.name+"/"+e.state[l.value])}console.log("Going to url ",s),window.location.href=s})})},geosite.controller_filter=function(e,a,t,r,o,n,s){angular.extend(this,t("GeositeControllerBase",{$element:a,$scope:e})),$(a).on("change",'input:radio[name="cat"]',function(a){console.log(a);var t=$(this).data("output"),r={};r[t]=this.value,intend("filterChanged",{layer:"popatrisk",filter:r},e)}),$(".geosite-filter-slider",$(a)).each(function(){var a=$(this).find(".geosite-filter-slider-slider"),t=$(this).find(".geosite-filter-slider-label"),o=a.data("type"),n=a.data("output");if("ordinal"==o){var s=a.data("range"),i=r.filters.popatrisk[n],l=a.data("options");a.data("label",t),t.html(a.data("label-template").replace("{value}",i)),a.slider({range:s,value:l.indexOf(i),min:0,max:l.length-1,step:1,slide:function(t,r){sparc_onslide_ordinal.apply(this,[t,r]);var o=a.data("options")[r.value],s={};s[n]=o,intend("filterChanged",{layer:"popatrisk",filter:s},e)}})}else{var s=a.data("range"),i=r.filters.popatrisk[n],c=a.data("min"),u=a.data("max"),p=a.data("step"),d=Math.floor(100*i),m=Math.floor(100*c),g=Math.floor(100*u),f=Math.floor(100*p);a.data("label",t),t.html(a.data("label-template").replace("{value}",i)),console.log(d,m,g,f,s),a.slider({range:s,value:d,min:m,max:g,step:f,slide:function(a,t){sparc_onslide_continuous.apply(this,[a,t]);var r=t.value/100,o={};o[n]=r,intend("filterChanged",{layer:"popatrisk",filter:o},e)}})}})};var init_map=function(e){var a=L.map("map",{zoomControl:opt_b(e,"zoom",!1),minZoom:opt_i(e,"minZoom",3),maxZoom:opt_i(e,"maxZoom",18)});return a.setView([opt_i(e,["latitude","lat"],0),opt_i(e,["longitude","lon","lng","long"],0)],opt_i(e,["zoom","z"],0)),$.each(opt_j(e,"listeners"),function(e,t){a.on(e,t)}),a},init_baselayers=function(e,a){for(var t={},r=0;r<a.length;r++){var o=a[r];try{t[o.id]=L.tileLayer(o.source.url,{id:o.id,attribution:o.source.attribution})}catch(n){console.log("Could not add baselayer "+r)}}return t};geosite.controller_map_map=function(e,a,t,r,o,n,s){var i={zoomend:function(a){var t={extent:s.map.getBounds().toBBoxString(),z:s.map.getZoom()};geosite.intend("viewChanged",t,e)},dragend:function(a){var t=s.map.getCenter(),r={extent:s.map.getBounds().toBBoxString(),lat:t.lat,lon:t.lng};geosite.intend("viewChanged",r,e)},moveend:function(a){var t=s.map.getCenter(),r={extent:s.map.getBounds().toBBoxString(),lat:t.lat,lon:t.lng};geosite.intend("viewChanged",r,e)}},l=r.view;s.map=init_map({zoom:n.controls.zoom,minZoom:n.view.minZoom,maxZoom:n.view.maxZoom,lat:l.lat,lon:l.lon,z:l.z,listeners:i});var c=init_baselayers(s.map,n.baselayers);$.extend(s.baselayers,c);var u=n.baselayers[0].id;s.baselayers[u].addTo(s.map),geosite.intend("viewChanged",{baselayer:u},e),geosite.intend("layerLoaded",{layer:u},e);var p=function(e){console.log(e);var a=e.feature,r=angular.element(document.body).injector().get("state"),s=r.filters.popatrisk,i=popup_templates.popatrisk,l=$.extend({},a.properties),c=months_short_3[r.month-1],u=months_long[r.month-1];if(l.month=u,"flood"==r.hazard){var p=s.rp;l.popatrisk=a.properties["RP"+p.toString(10)][c]}var d=n.featurelayers.popatrisk.popup.chart;return l.chartID=d.id,setTimeout(function(){var e=buildGroupsAndColumnsForAdmin2(d,o,a.properties.admin2_code),t={groups:e.groups,columns:e.columns,bullet_width:function(e,a){return"rp25"==e.id?6:12}};buildHazardChart(d,o,t)},1e3),t(i)(l)};s.featurelayers.popatrisk=L.geoJson(o.data.geojson,{renderOrder:$.inArray("popatrisk",n.renderlayers),style:o.style["default"],hoverStyle:o.style.hover,onEachFeature:function(e,a){var t={maxWidth:300};a.bindPopup(p,t),a.on({mouseover:highlightFeature,mouseout:function(e){s.featurelayers.popatrisk.resetStyle(e.target)},click:function(e){}})}}),$.each(n.featurelayers,function(e,a){if("popatrisk"!=e&&(void 0==a.enabled||1==a.enabled)&&"wms"==a.type.toLowerCase()){var t=a.wms,r=L.tileLayer.wms(t.url,{renderOrder:$.inArray(e,n.renderlayers),buffer:t.buffer||0,version:t.version||"1.1.1",layers:t.layers.join(","),styles:t.styles?t.styles.join(","):"",format:t.format,transparent:t.transparent||!1,attribution:a.source});s.featurelayers[e]=r}}),$.each(s.featurelayers,function(a,t){t.addTo(s.map),geosite.intend("layerLoaded",{layer:a},e)}),hasHashValue(["latitude","lat","longitude","lon","lng","zoom","z"])||s.map.fitBounds(s.featurelayers.popatrisk.getBounds()),$("#sparc-sidebar-toggle").click(function(){$(this).toggleClass("sidebar-open"),$("#sparc-sidebar, #sparc-map").toggleClass("sidebar-open"),setTimeout(function(){s.map.invalidateSize({animate:!0,pan:!1})},2e3)}),e.$on("refreshMap",function(e,a){console.log("Refreshing map...");var t=a.state.view.baselayer;$.each(s.baselayers,function(e,a){var r=e==t;s.map.hasLayer(a)&&!r?s.map.removeLayer(a):!s.map.hasLayer(a)&&r&&s.map.addLayer(a)});var r=a.state.view.featurelayers;$.each(s.featurelayers,function(e,a){var t=-1!=$.inArray(e,r);s.map.hasLayer(a)&&!t?s.map.removeLayer(a):!s.map.hasLayer(a)&&t&&s.map.addLayer(a)});var n=$.grep(layersAsArray(s.featurelayers),function(e){return-1!=$.inArray(e.id,r)}),i=sortLayers($.map(n,function(e,a){return e.layer}),!0),l=($.map(s.baselayers,function(e,a){return{id:a,layer:e}}),$.map($.grep(layersAsArray(s.baselayers),function(e){return e.id==t}),function(e,a){return e.layer}));updateRenderOrder(l.concat(i)),s.featurelayers.popatrisk.setStyle(o.style["default"]),setTimeout(function(){s.map._onResize()},0)}),e.$on("changeView",function(e,a){console.log("Refreshing map..."),void 0!=a.layer&&s.map.fitBounds(s.featurelayers[a.layer].getBounds())})},geosite.controller_sidebar=function(e,a,t,r,o,n,s){angular.extend(this,t("GeositeControllerBase",{$element:a,$scope:e}));$(a);if(void 0!=n.charts)for(var i=0;i<n.charts.length;i++){var l={};"drought"==n.charts[i].hazard&&(l.bullet_width=function(e,a){return"p6"==e.id?6:"p8"==e.id?8:16}),buildHazardChart(n.charts[i],o,l)}};var buildPageURL=function(e,a){var t=sparc.pages[e].url.replace("{iso3}",a.iso3).replace("{hazard}",a.hazard).replace("{month}",a.month),r=[],o=a.view;void 0!=o&&void 0!=o.z&&void 0!=o.lat&&void 0!=o.lon&&(r.push("z="+o.z),r.push("lat="+o.lat.toFixed(4)),r.push("lon="+o.lon.toFixed(4)));var n=a.filters;return n&&$.each(a.filters,function(e,a){$.each(a,function(a,t){r.push(e+":"+a+"="+t)})}),r.length>0&&(t+="#"+r.join("&")),t};